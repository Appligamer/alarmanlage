<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alarmanlage Control</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 400px;
    margin: 30px auto;
    background-color: #f4f7f8;
    padding: 20px;
    border-radius: 8px;
    color: #333;
  }
  h1 {
    text-align: center;
  }
  .status {
    font-size: 1.2rem;
    margin-bottom: 15px;
    text-align: center;
  }
  button {
    padding: 10px 18px;
    font-size: 1rem;
    margin: 5px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    background-color: #0057b7;
    color: white;
  }
  button:hover {
    background-color: #004099;
  }
  .error {
    color: red;
    margin-top: 15px;
    text-align: center;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Alarmanlage Steuerung</h1>
  <div class="status" id="statusText">Lade Status...</div>
  <div style="text-align:center;">
    <button id="toggleBtn">Alarm an/aus</button>
    <button id="increaseBtn">+10 cm AE</button>
    <button id="decreaseBtn">-10 cm AE</button>
  </div>
  <div class="error" id="errorMsg"></div>

<script>
  // Supabase-Setup
  const SUPABASE_URL = 'https://rshbpsxqbabpxhdztozz.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGJwc3hxYmFicHhoZHp0b3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjYyMDgsImV4cCI6MjA2NTk0MjIwOH0.4MG6d3QkPv7hj7PcCacZgXp-8YRD_2ANHd7bvFzxtX4';

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Benutzer-ID (ersetze mit echter User-ID)
  const userId = 'ae3e82b9-eedf-49d8-afdc-afcbc9da9669';

  // HTML-Elemente
  const statusText = document.getElementById('statusText');
  const errorMsg = document.getElementById('errorMsg');
  const toggleBtn = document.getElementById('toggleBtn');
  const increaseBtn = document.getElementById('increaseBtn');
  const decreaseBtn = document.getElementById('decreaseBtn');

  // Status im Speicher
  let currentStatus = false;
  let currentAe = 100;

  // Status laden
  async function loadStatus() {
    errorMsg.textContent = '';
    try {
      const { data, error } = await supabase
        .from('anlage_status')
        .select('status, ae')
        .eq('user_id', userId)
        .single();

      if (error) throw error;
      if (data) {
        currentStatus = data.status;
        currentAe = data.ae;
        updateStatusText();
      } else {
        // Falls kein Eintrag, erstelle einen
        await supabase.from('anlage_status').insert([{ user_id: userId, status: false, ae: 100 }]);
        currentStatus = false;
        currentAe = 100;
        updateStatusText();
      }
    } catch (err) {
      errorMsg.textContent = 'Fehler beim Laden des Status: ' + err.message;
    }
  }

  // Statusanzeige aktualisieren
  function updateStatusText() {
    statusText.textContent = `Alarm: ${currentStatus ? 'AKTIV' : 'AUS'} | AE: ${currentAe} cm`;
  }

  // Status updaten (Status oder AE)
  async function updateStatus(newStatus, newAe) {
    errorMsg.textContent = '';
    try {
      const { error } = await supabase
        .from('anlage_status')
        .update({ status: newStatus, ae: newAe })
        .eq('user_id', userId);

      if (error) throw error;

      currentStatus = newStatus;
      currentAe = newAe;
      updateStatusText();
    } catch (err) {
      errorMsg.textContent = 'Fehler beim Aktualisieren: ' + err.message;
    }
  }

  // Event-Handler
  toggleBtn.onclick = () => {
    updateStatus(!currentStatus, currentAe);
  };

  increaseBtn.onclick = () => {
    let newAe = currentAe + 10;
    if (newAe > 500) newAe = 500;
    updateStatus(currentStatus, newAe);
  };

  decreaseBtn.onclick = () => {
    let newAe = currentAe - 10;
    if (newAe < 0) newAe = 0;
    updateStatus(currentStatus, newAe);
  };

  // Initial
  loadStatus();
</script>
</body>
</html>
