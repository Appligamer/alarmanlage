#include <WiFi.h>
#include <HTTPClient.h>
#include <LiquidCrystal_I2C.h>

// -------- CONFIG ----------
const char* ssid      = "Dukar";
const char* password  = "KarmapaChenno-108!";
const char* supaGet   = "https://rshbpsxqbabpxhdztozz.supabase.co/rest/v1/anlage_status?select=status,ae,alarm&user_id=eq.ae3e82b9-eedf-49d8-afdc-afcbc9da9669";
const char* supaPatch = "https://rshbpsxqbabpxhdztozz.supabase.co/rest/v1/anlage_status?user_id=eq.ae3e82b9-eedf-49d8-afdc-afcbc9da9669";
const char* apiKey    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";  // dein Key

const int pinPoti   = 34;
const int pinBtn    = 12;
const int pinRed    = 15;
const int pinGreen  = 2;
const int pinBlue   = 4;
const int uartRx    = 16; // RX vom Sensor

LiquidCrystal_I2C lcd(0x27,16,2);

// -------- VARS ------------
enum Sts { AUS=0, ENT=1, SCH=2 };
Sts  statusLocal = AUS;
bool webMode    = false;
bool btnPressed = false;
int  aeLocal    = 100;
int  aeWeb      = 200;
int  distance   = 0;
bool alarmAct   = false;
unsigned long lastFetch=0;

// -------- SETUP -----------
void setup(){
  Serial.begin(115200);
  Serial.println("Setup starten");
  pinMode(pinBtn, INPUT_PULLUP);
  pinMode(pinRed, OUTPUT);
  pinMode(pinGreen, OUTPUT);
  pinMode(pinBlue, OUTPUT);
  Serial2.begin(9600, SERIAL_8N1, uartRx, -1);

  lcd.init(); lcd.backlight();
  Serial.print("Verbinde WLAN ");
  WiFi.begin(ssid,password);
  while(WiFi.status()!=WL_CONNECTED){
    Serial.print("."); delay(300);
  }
  Serial.println("\nWLAN verbunden: " + WiFi.localIP().toString());

  // Erste Web-Abfrage
  fetchWeb();
}

// ------ LOOP ------------
void loop(){
  int pot = analogRead(pinPoti);
  webMode = (pot >= 500);
  aeLocal = map(pot,0,4095,0,400);

  if(Serial2.available()){
    distance = Serial2.parseInt();
    Serial.println("Sensor-Distanz: " + String(distance));
  }

  bool btn = digitalRead(pinBtn)==LOW;
  if(btn && !btnPressed){
    btnPressed=true; Serial.println("Knopf gedrückt");
  }
  if(!btn && btnPressed){
    btnPressed=false;
    if(!webMode){
      statusLocal = Sts((statusLocal+1)%3);
      Serial.println("Status lokal gesetzt auf: " + String(statusLocal));
      patchWeb();
    } else {
      Serial.println("Webmodus: Knopf ignoriert");
    }
  }

  if(millis()-lastFetch>10000){
    fetchWeb();
    lastFetch=millis();
  }

  // Alarm: Scharf-Modus und Distanz < AE
  int AE = webMode?aeWeb:aeLocal;
  alarmAct = (statusLocal==SCH && distance<AE);
  Serial.printf("Modus:%s AE=%d WebAE=%d Status=%d Alarm=%d\n",
    webMode?"WEB":"MAN", aeLocal, aeWeb, statusLocal, alarmAct);

  // LCD Zeile 1
  lcd.setCursor(0,0);
  lcd.printf("D:%4d AE:%3d", distance, AE);
  // LCD Zeile 2
  lcd.setCursor(0,1);
  const char* txt[]={"AUS","ENT","SCH"};
  lcd.print("S:"); lcd.print(txt[statusLocal]);
  if(alarmAct){
    lcd.print(" !!!");
    blinkLED();
  } else {
    lcd.print("    ");
    setLED(statusLocal==ENT, statusLocal==SCH);
  }

  delay(200);
}

// ---- Web-Funktionen ----
void fetchWeb(){
  if(WiFi.status()!=WL_CONNECTED) return;
  HTTPClient http;
  http.begin(supaGet);
  http.addHeader("apikey",apiKey);
  http.addHeader("Authorization","Bearer "+String(apiKey));
  int code=http.GET();
  Serial.println("GET Web-Code: "+String(code));
  if(code==200){
    String p = http.getString();
    Serial.println("GET Payload: "+p);
    int iS=p.indexOf("\"status\":");
    int iA=p.indexOf("\"ae\":");
    int iL=p.indexOf("\"alarm\":");
    if(iS>0&&iA>0&&iL>0){
      statusLocal = Sts(p.substring(iS+9,p.indexOf(",",iS)).toInt());
      aeWeb       = p.substring(iA+5,p.indexOf(",",iA)).toInt();
      alarmAct    = (p.substring(iL+8,p.indexOf("}",iL)).indexOf("true")>=0);
      Serial.printf("Web→ Status:%d AE:%d Alarm:%d\n",statusLocal,aeWeb,alarmAct);
    }
  }
  http.end();
}

void patchWeb(){
  if(WiFi.status()!=WL_CONNECTED) return;
  HTTPClient http;
  http.begin(supaPatch);
  http.addHeader("apikey",apiKey);
  http.addHeader("Authorization","Bearer "+String(apiKey));
  http.addHeader("Content-Type","application/json");
  String b = "{\"status\":"+String((int)statusLocal)
           +",\"ae\":"+String(aeLocal)
           +",\"alarm\":"+(alarmAct?"true":"false")+"}";
  int c = http.sendRequest("PATCH",b);
  Serial.println("PATCH Code: "+String(c)+" Body:"+b);
  http.end();
}

// ---- LED-Hilfen ----
void blinkLED(){
  bool on=(millis()%1000<500);
  digitalWrite(pinRed,on);
  digitalWrite(pinGreen,LOW);
  digitalWrite(pinBlue,LOW);
}
void setLED(bool bBlue,bool bGreen){
  digitalWrite(pinRed,LOW);
  digitalWrite(pinBlue,bBlue);
  digitalWrite(pinGreen,bGreen);
}
