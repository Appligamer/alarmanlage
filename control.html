<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alarmanlage Websteuerung</title>
</head>
<body>

<h1>Alarmanlage Websteuerung</h1>

<div>Status: <span id="status">lade...</span></div>
<div>Alarm: <span id="alarm">lade...</span></div>
<div>AE Wert: <span id="ae">lade...</span></div>

<button id="toggleStatus">Status wechseln</button>
<button id="toggleAlarm">Alarm an/aus</button>

<script>
const API_URL = "https://rshbpsxqbabpxhdztozz.supabase.co/rest/v1/anlage_status";
const USER_ID = "ae3e82b9-eedf-49d8-afdc-afcbc9da9669";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGJwc3hxYmFicHhoZHp0b3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjYyMDgsImV4cCI6MjA2NTk0MjIwOH0.4MG6d3QkPv7hj7PcCacZgXp-8YRD_2ANHd7bvFzxtX4";

async function loadStatus() {
  try {
    const res = await fetch(`${API_URL}?user_id=eq.${USER_ID}&select=status,ae,alarm`, {
      method: "GET",
      headers: {
        "apikey": API_KEY,
        "Authorization": "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "Accept": "application/json"
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data || data.length === 0) throw new Error("Keine Daten gefunden");
    const statusData = data[0];

    document.getElementById("status").textContent = statusData.status;
    document.getElementById("alarm").textContent = statusData.alarm ? "Alarm" : "Kein Alarm";
    document.getElementById("ae").textContent = statusData.ae;

  } catch (e) {
    console.error("Fehler beim Laden:", e);
    document.getElementById("status").textContent = "Fehler";
    document.getElementById("alarm").textContent = "Fehler";
    document.getElementById("ae").textContent = "Fehler";
  }
}

async function updateStatus(newStatus) {
  try {
    const res = await fetch(`${API_URL}?user_id=eq.${USER_ID}`, {
      method: "PATCH",
      headers: {
        "apikey": API_KEY,
        "Authorization": "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ status: newStatus })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    await loadStatus();
  } catch (e) {
    console.error("Fehler beim Aktualisieren:", e);
  }
}

async function toggleAlarm() {
  try {
    // Status umschalten (Beispiel: alarm toggeln)
    const alarmText = document.getElementById("alarm").textContent;
    const newAlarm = alarmText === "Alarm" ? false : true;

    const res = await fetch(`${API_URL}?user_id=eq.${USER_ID}`, {
      method: "PATCH",
      headers: {
        "apikey": API_KEY,
        "Authorization": "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ alarm: newAlarm })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    await loadStatus();
  } catch (e) {
    console.error("Fehler beim Alarm-Schalten:", e);
  }
}

window.onload = () => {
  loadStatus();
  setInterval(loadStatus, 5000);

  document.getElementById("toggleStatus").addEventListener("click", async () => {
    const currentStatus = document.getElementById("status").textContent;
    const newStatus = currentStatus === "1" ? 0 : 1;
    await updateStatus(newStatus);
  });

  document.getElementById("toggleAlarm").addEventListener("click", async () => {
    await toggleAlarm();
  });
};
</script>

</body>
</html>
