<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarmanlage Steuerung</title>
  <style>
    body { font-family: Arial,sans-serif; max-width:500px; margin:2rem auto; background:#fafafa; padding:1rem; border-radius:8px; }
    #alarmBanner { display:none; background:crimson; color:white; padding:1rem; font-size:1.25rem; text-align:center; margin-bottom:1rem; border-radius:4px; }
    label { display:block; margin-top:1rem; font-weight:bold; }
    select,input { width:100%; padding:0.5rem; margin-top:0.5rem; font-size:1rem; }
    button { margin-top:1.5rem; width:100%; padding:0.75rem; font-size:1rem; background:#2a7ae2; color:white; border:none; border-radius:4px; }
    #statusText { margin-top:1rem; color:#555; }
  </style>
</head>
<body>

  <h1>Alarmanlage Steuerung</h1>
  <div id="alarmBanner">⚠️ ALARM AKTIV! (SCHARF)</div>

  <label for="statusSelect">Status</label>
  <select id="statusSelect">
    <option value="0">AUS</option>
    <option value="1">ENTSCHÄRFT</option>
    <option value="2">SCHARF</option>
  </select>

  <label for="aeInput">Alarmentfernung (AE)</label>
  <input id="aeInput" type="number" min="0" max="400" />

  <button id="saveBtn">Änderungen speichern</button>
  <div id="statusText">Lade Daten…</div>

  <script>
    // Supabase REST-Konfiguration
    const API_BASE = 'https://rshbpsxqbabpxhdztozz.supabase.co/rest/v1/anlage_status';
    const FILTER   = '?user_id=eq.ae3e82b9-eedf-49d8-afdc-afcbc9da9669';
    const HEADERS  = {
      'apikey':        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
      'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
      'Content-Type':  'application/json'
    };

    const alarmBanner  = document.getElementById('alarmBanner');
    const statusSelect = document.getElementById('statusSelect');
    const aeInput      = document.getElementById('aeInput');
    const saveBtn      = document.getElementById('saveBtn');
    const statusText   = document.getElementById('statusText');

    let lastAlarm = false;

    // 1) Daten laden
    async function loadData() {
      try {
        const res = await fetch(API_BASE + FILTER + '&select=status,ae', { headers: HEADERS });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const [row] = await res.json();
        if (!row) throw new Error('Keine Daten');
        const { status, ae } = row;

        statusSelect.value = status;
        aeInput.value      = ae;
        statusText.textContent = `Status: ${['AUS','ENTSCHÄRFT','SCHARF'][status]} | AE: ${ae}`;
        updateAlarmUI(status === 2);
      } catch (e) {
        statusText.textContent = 'Fehler: ' + e.message;
        alarmBanner.style.display = 'none';
      }
    }

    // 2) Änderungen speichern
    async function saveData() {
      saveBtn.disabled = true;
      statusText.textContent = 'Speichere…';
      try {
        const payload = {
          status: parseInt(statusSelect.value),
          ae:     parseInt(aeInput.value)
        };
        const res = await fetch(API_BASE + FILTER, {
          method: 'PATCH',
          headers: HEADERS,
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        statusText.textContent = 'Gespeichert: ' + new Date().toLocaleTimeString();
      } catch (e) {
        statusText.textContent = 'Fehler: ' + e.message;
      } finally {
        saveBtn.disabled = false;
      }
    }

    // 3) Alarm-UI + Notification
    function updateAlarmUI(active) {
      if (active) {
        alarmBanner.style.display = 'block';
        if (!lastAlarm && Notification.permission === 'granted') {
          new Notification('Alarm!', { body: 'Alarmanlage ist SCHARF!' });
        }
      } else {
        alarmBanner.style.display = 'none';
      }
      lastAlarm = active;
    }

    // Polling alle 5 Sekunden
    setInterval(loadData, 5000);

    // Init
    if (Notification.permission === 'default') Notification.requestPermission();
    saveBtn.addEventListener('click', saveData);
    loadData();
  </script>
</body>
</html>
