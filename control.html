<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarmanlage Control</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>

<h1>Alarmanlage Control</h1>

<div id="status-container">
  <p>Status der Alarmanlage: <span id="status-text">Lade...</span></p>
  <button id="toggle-status-btn">Status ändern</button>
</div>

<div id="ae-container">
  <p>Alarmentfernung (AE): <span id="ae-value">Lade...</span> cm</p>
  <button id="ae-decrease-btn">- 10 cm</button>
  <button id="ae-increase-btn">+ 10 cm</button>
</div>

<button id="logout-btn">Logout</button>

<script>
  const supabaseUrl = 'https://rshbpsxqbabpxhdztozz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGJwc3hxYmFicHhoZHp0b3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjYyMDgsImV4cCI6MjA2NTk0MjIwOH0.4MG6d3QkPv7hj7PcCacZgXp-8YRD_2ANHd7bvFzxtX4'; // Hier deinen echten anon key einfügen

  // Supabase Client korrekt initialisieren (nicht supabase überschreiben)
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const statusText = document.getElementById('status-text');
  const toggleStatusBtn = document.getElementById('toggle-status-btn');
  const aeValue = document.getElementById('ae-value');
  const aeDecreaseBtn = document.getElementById('ae-decrease-btn');
  const aeIncreaseBtn = document.getElementById('ae-increase-btn');
  const logoutBtn = document.getElementById('logout-btn');

  let currentStatus = false;
  let currentAe = 100;
  let userId = null;

  async function checkUser() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      alert('Nicht eingeloggt. Bitte zuerst anmelden.');
      window.location.href = 'login.html'; // ggf. anpassen
      return false;
    }
    userId = session.user.id;
    return true;
  }

  async function ladeStatus() {
    if (!userId) return;
    const { data, error } = await supabaseClient
      .from('anlage_status')
      .select('status, ae')
      .eq('user_id', userId)
      .single();

    if (error) {
      console.error('Fehler beim Laden:', error);
      statusText.textContent = 'Fehler beim Laden';
      aeValue.textContent = '-';
      return;
    }

    if (!data) {
      // Falls noch kein Datensatz existiert, Standardwerte anzeigen
      currentStatus = false;
      currentAe = 100;
      statusText.textContent = 'Aus';
      aeValue.textContent = currentAe;
      return;
    }

    currentStatus = data.status;
    currentAe = data.ae;

    statusText.textContent = currentStatus ? 'Ein' : 'Aus';
    aeValue.textContent = currentAe;
  }

  async function updateAnlage() {
    if (!userId) return;
    const { error } = await supabaseClient
      .from('anlage_status')
      .upsert({
        user_id: userId,
        status: currentStatus,
        ae: currentAe
      }, { onConflict: 'user_id' });

    if (error) {
      console.error('Fehler beim Aktualisieren:', error);
      alert('Fehler beim Speichern.');
      return;
    }
    statusText.textContent = currentStatus ? 'Ein' : 'Aus';
    aeValue.textContent = currentAe;
  }

  toggleStatusBtn.addEventListener('click', async () => {
    currentStatus = !currentStatus;
    await updateAnlage();
  });

  aeDecreaseBtn.addEventListener('click', async () => {
    if (currentAe > 10) {
      currentAe -= 10;
      await updateAnlage();
    }
  });

  aeIncreaseBtn.addEventListener('click', async () => {
    if (currentAe < 1000) {  // Limit kannst du anpassen
      currentAe += 10;
      await updateAnlage();
    }
  });

  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'login.html'; // ggf. anpassen
  });

  // Seite initial laden
  (async () => {
    const loggedIn = await checkUser();
    if (loggedIn) {
      await ladeStatus();
    }
  })();
</script>

</body>
</html>
