<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarmanlage Steuerung</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 2rem auto; background:#fafafa; padding:1rem; border-radius:8px; }
    #alarmBanner { display:none; background:crimson; color:white; padding:1rem; font-size:1.25rem; text-align:center; margin-bottom:1rem; border-radius:4px; }
    label { display:block; margin-top:1rem; font-weight:bold; }
    select,input { width:100%; padding:0.5rem; margin-top:0.5rem; font-size:1rem; }
    button { margin-top:1.5rem; width:100%; padding:0.75rem; font-size:1rem; background:#2a7ae2; color:white; border:none; border-radius:4px; cursor:pointer; }
    #statusText { margin-top:1rem; color:#555; }
  </style>
</head>
<body>

  <h1>Alarmanlage Steuerung</h1>
  <div id="alarmBanner">⚠️ ALARM AKTIV!</div>

  <label for="statusSelect">Status</label>
  <select id="statusSelect">
    <option value="0">AUS</option>
    <option value="1">ENTSCHÄRFT</option>
    <option value="2">SCHARF</option>
  </select>

  <label for="aeInput">Alarmentfernung (AE)</label>
  <input id="aeInput" type="number" min="0" max="400" />

  <button id="saveBtn">Änderungen speichern</button>
  <div id="statusText">Lade Daten…</div>

  <!-- 1) Supabase Client laden -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 2) Supabase initialisieren
    const SUPA_URL = 'https://rshbpsxqbabpxhdztozz.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…'; // <–– vollständigen Key einsetzen
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);
    const userId = 'ae3e82b9-eedf-49d8-afdc-afcbc9da9669';

    // 3) UI-Elemente
    const alarmBanner = document.getElementById('alarmBanner');
    const statusSelect = document.getElementById('statusSelect');
    const aeInput     = document.getElementById('aeInput');
    const saveBtn     = document.getElementById('saveBtn');
    const statusText  = document.getElementById('statusText');
    const alarmSound  = new Audio('alarm-sound.mp3'); // optional

    let lastAlarm = false;

    // 4) Daten laden
    async function loadData() {
      try {
        const { data, error } = await supabase
          .from('anlage_status')
          .select('status,ae,alarm')
          .eq('user_id', userId)
          .single();
        if (error) throw error;

        statusSelect.value = data.status;
        aeInput.value     = data.ae;
        updateAlarmUI(data.alarm);

        statusText.textContent =
          `Status: ${['AUS','ENTSCHÄRFT','SCHARF'][data.status]} | AE: ${data.ae}`;
      } catch (err) {
        statusText.textContent = 'Fehler: ' + err.message;
      }
    }

    // 5) Status speichern
    async function saveData() {
      saveBtn.disabled = true;
      statusText.textContent = 'Speichere…';
      try {
        const payload = {
          status: parseInt(statusSelect.value),
          ae:     parseInt(aeInput.value)
        };
        const { error } = await supabase
          .from('anlage_status')
          .update(payload)
          .eq('user_id', userId);
        if (error) throw error;
        statusText.textContent = 'Gespeichert: ' + new Date().toLocaleTimeString();
      } catch (err) {
        statusText.textContent = 'Fehler: ' + err.message;
      } finally {
        saveBtn.disabled = false;
      }
    }

    // 6) Alarm-UI
    function updateAlarmUI(alarmActive) {
      if (alarmActive) {
        alarmBanner.style.display = 'block';
        if (!lastAlarm) {
          if (Notification.permission==='granted') {
            new Notification('Alarm!', { body:'Alarmanlage ausgelöst!' });
          }
          alarmSound.play().catch(()=>{});
        }
      } else {
        alarmBanner.style.display = 'none';
      }
      lastAlarm = alarmActive;
    }

    // 7) Realtime abonnieren (nach Supabase-Client-Init)
    supabase
      .channel('public:anlage_status')
      .on('postgres_changes',
        { event:'UPDATE', schema:'public', table:'anlage_status', filter:`user_id=eq.${userId}` },
        payload => {
          const d = payload.new;
          statusSelect.value = d.status;
          aeInput.value      = d.ae;
          updateAlarmUI(d.alarm);
          statusText.textContent = 'Realtime: ' +
            `Status ${['AUS','ENT','SCH'][d.status]}, AE ${d.ae}`;
        }
      )
      .subscribe();

    // 8) Polling als Fallback
    setInterval(loadData, 5000);

    // 9) Notification-Rechte
    if (Notification.permission==='default') {
      Notification.requestPermission();
    }

    // 10) Event-Handler
    saveBtn.addEventListener('click', saveData);

    // 11) Erste Datenladung
    loadData();
  </script>
</body>
</html>
