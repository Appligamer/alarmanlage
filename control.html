<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alarmanlage Steuerung</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1rem;
    background: #f0f0f0;
    color: #222;
  }
  #alarmBanner {
    display: none;
    background-color: red;
    color: white;
    padding: 1rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 1rem;
  }
  #statusContainer {
    margin-bottom: 1rem;
  }
  label {
    display: inline-block;
    width: 120px;
  }
  select, input[type=number] {
    width: 100px;
    margin-right: 1rem;
  }
  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
  }
  #info {
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #555;
  }
</style>
</head>
<body>

<h1>Alarmanlage Steuerung</h1>

<div id="alarmBanner">ALARM AKTIV!</div>

<div id="statusContainer">
  <label for="statusSelect">Status:</label>
  <select id="statusSelect">
    <option value="0">AUS</option>
    <option value="1">ENTSCHÄRFT</option>
    <option value="2">SCHARF</option>
  </select>
</div>

<div id="aeContainer">
  <label for="aeInput">AE Wert:</label>
  <input type="number" id="aeInput" min="0" max="400" />
</div>

<button id="updateButton">Status aktualisieren</button>

<div id="info"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase Einstellungen
  const supabaseUrl = 'https://rshbpsxqbabpxhdztozz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGJwc3hxYmFicHhoZHp0b3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjYyMDgsImV4cCI6MjA2NTk0MjIwOH0.4MG6d3QkPv7hj7PcCacZgXp-8YRD_2ANHd7bvFzxtX4';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Nutzer-ID oder eindeutiger Filter, damit wir nur den richtigen Datensatz lesen und schreiben
  const userId = 'ae3e82b9-eedf-49d8-afdc-afcbc9da9669';

  // HTML Elemente
  const statusSelect = document.getElementById('statusSelect');
  const aeInput = document.getElementById('aeInput');
  const updateButton = document.getElementById('updateButton');
  const alarmBanner = document.getElementById('alarmBanner');
  const info = document.getElementById('info');

  // Status-Text Array (muss zu ESP32 passen)
  const statusText = ["AUS", "ENTSCHÄRFT", "SCHARF"];

  // Daten laden
  async function loadStatus() {
    const { data, error } = await supabase
      .from('anlage_status')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (error) {
      info.textContent = 'Fehler beim Laden der Daten: ' + error.message;
      return;
    }

    statusSelect.value = data.status.toString();
    aeInput.value = data.ae;
    alarmBanner.style.display = data.alarm ? 'block' : 'none';
    info.textContent = 'Letztes Update: ' + new Date().toLocaleTimeString();
  }

  // Status aktualisieren (PATCH)
  async function updateStatus() {
    const status = parseInt(statusSelect.value);
    const ae = parseInt(aeInput.value);

    if (isNaN(ae) || ae < 0 || ae > 400) {
      alert('Bitte einen gültigen AE Wert zwischen 0 und 400 eingeben.');
      return;
    }

    const payload = {
      status: status,
      ae: ae
    };

    const { error } = await supabase
      .from('anlage_status')
      .update(payload)
      .eq('user_id', userId);

    if (error) {
      info.textContent = 'Fehler beim Aktualisieren: ' + error.message;
    } else {
      info.textContent = 'Status erfolgreich aktualisiert: ' + new Date().toLocaleTimeString();
      await loadStatus();
    }
  }

  // Live-Update mit Supabase Realtime (wenn in DB unterstützt)
  supabase
    .channel('public:anlage_status')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'anlage_status', filter: `user_id=eq.${userId}` },
      payload => {
        console.log('Realtime update:', payload);
        loadStatus();
      }
    )
    .subscribe();

  // Button Event
  updateButton.addEventListener('click', updateStatus);

  // Initialer Status-Load
  loadStatus();

  // Optional: Alle 5 Sekunden automatisch Status nachladen
  setInterval(loadStatus, 5000);
</script>

</body>
</html>
