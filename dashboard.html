<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif; margin: 20px; background: #f0f4f8;
    }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background: white; padding: 15px 30px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { margin: 0; }
    button {
      background: #dc3545; color: white; border: none; padding: 10px 20px;
      border-radius: 6px; cursor: pointer; font-size: 1em;
    }
    button:hover { background: #a71d2a; }
    .container {
      background: white; padding: 30px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 12px; text-align: left;
    }
    th {
      background-color: #007bff; color: white;
    }
    .add-system {
      margin-top: 20px; display: flex; gap: 10px;
    }
    input[type="text"] {
      flex-grow: 1; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .btn-primary {
      background: #007bff; color: white; border: none;
      padding: 10px 20px; border-radius: 6px; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard</h1>
    <button id="logout-btn">Logout</button>
  </header>

  <div class="container">
    <h2>Willkommen, <span id="user-email"></span></h2>

    <h3>Deine Alarmanlagen</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>AE (Alarmentfernung)</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="systems-table-body">
        <!-- Alarmanlagen werden hier geladen -->
      </tbody>
    </table>

    <div class="add-system">
      <input type="text" id="new-system-name" placeholder="Neue Alarmanlage Name" />
      <button class="btn-primary" id="add-system-btn">Hinzufügen</button>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://rshbpsxqbabpxhdztozz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGJwc3hxYmFicHhoZHp0b3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjYyMDgsImV4cCI6MjA2NTk0MjIwOH0.4MG6d3QkPv7hj7PcCacZgXp-8YRD_2ANHd7bvFzxtX4'
    );

    let user;

    async function checkUser() {
      const { data: { user: currentUser } } = await supabase.auth.getUser();
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }
      user = currentUser;
      document.getElementById('user-email').textContent = user.email;
      loadSystems();
    }

    async function loadSystems() {
      const { data, error } = await supabase
        .from('alarmanlagen')
        .select('*')
        .eq('user_id', user.id);

      const tbody = document.getElementById('systems-table-body');
      tbody.innerHTML = '';

      if (error) {
        tbody.innerHTML = `<tr><td colspan="4">Fehler beim Laden: ${error.message}</td></tr>`;
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">Keine Alarmanlagen gefunden.</td></tr>`;
        return;
      }

      data.forEach(system => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${system.name}</td>
          <td>${system.status}</td>
          <td>${system.alarmentfernung} cm</td>
          <td>
            <button onclick="toggleStatus('${system.id}', '${system.status}')">Status ändern</button>
            <button onclick="deleteSystem('${system.id}')">Löschen</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function toggleStatus(id, currentStatus) {
      const newStatus = currentStatus === 'aktiv' ? 'inaktiv' : 'aktiv';
      const { error } = await supabase
        .from('alarmanlagen')
        .update({ status: newStatus })
        .eq('id', id);

      if (error) {
        alert('Fehler beim Ändern des Status: ' + error.message);
        return;
      }
      loadSystems();
    }

    async function deleteSystem(id) {
      if (!confirm('Alarmanlage wirklich löschen?')) return;
      const { error } = await supabase
        .from('alarmanlagen')
        .delete()
        .eq('id', id);
      if (error) {
        alert('Fehler beim Löschen: ' + error.message);
        return;
      }
      loadSystems();
    }

    document.getElementById('add-system-btn').addEventListener('click', async () => {
      const name = document.getElementById('new-system-name').value.trim();
      if (!name) {
        alert('Bitte einen Namen eingeben');
        return;
      }
      const { error } = await supabase
        .from('alarmanlagen')
        .insert([{ name, user_id: user.id, status: 'inaktiv', alarmentfernung: 100 }]);
      if (error) {
        alert('Fehler beim Hinzufügen: ' + error.message);
        return;
      }
      document.getElementById('new-system-name').value = '';
      loadSystems();
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    });

    checkUser();
  </script>
</body>
</html>
